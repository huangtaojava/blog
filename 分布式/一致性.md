## 前言

一致性指的是在分布式系统中，多个节点（服务器、进程）对同一份数据的状态达成共识的程度和规则。
<br>
它解决的核心问题是：在数据被复制到多个节点、且可能同时被并发读写的情况下，如何保证所有节点看到的数据是“正确”的、符合预期的？

## CAP理论

理解分布式一致性离不开CAP定理。它指出，在一个可能发生网络分区（P）的分布式系统中，不可能同时满足以下三点：

     ● C一致性：写操作之后，访问任意节点，返回最新的写操作的值。
     ● A可用性：非故障节点在合理的时间内返回合理的相应，不能是报错或者超时。
     ● P分区容错性：当出现网络分区后，整个系统任能继续工作。

CAP 定理意味着我们必须根据应用场景在 C 和 A 之间做出权衡，这直接导致了不同一致性模型的产生。

## 一致性视角

一致性视角分为状态一致性（State Consistency）和操作一致性（Operation Consistency）。

    ● 状态一致性是指，数据所处的客观、实际状态所体现的一致性；
    ● 操作一致性是指，外部用户通过协议约定的操作，能够读取到的数据一致性。

## 状态视角

从状态的视角来看，任何变更操作后，数据只有两种状态，所有副本一致或者不一致。

### 强一致性

状态视角的强一致性说的是应答客户端写操作成功后，所有节点的数据都是一致的，这是最高的一致性状态，典型的实现是MySQL主从同步复制。

### 弱一致性

弱一致性也叫最终一致性，字面意思，写操作成功后，不保证所有节点数据都一致，但是经过一段时间后，节点数据最终都会一致。
<br>
像MySQL的异步复制，Redis的主从同步都是弱一致性的实现。

## 操作视角

### 写后读一致性

自己写入成功的任何数据，下一刻一定能读取到，其内容保证与自己最后一次写入完全一致。

### 单调读一致性

数据x更新1->2->3，读到新值3后，不可以再读到旧值1或者2。

### 因果一致性（会话一致性）

保证有因果关系的操作（如A写入后B基于A的值进行写入）在所有节点上看到的顺序是一致的。而对于并发（无因果关联）的操作，不同节点看到的顺序可以不同。

### 顺序一致性

所有节点看到的操作（读和写）的执行顺序是一致的，并且每个节点的操作顺序符合其程序顺序。不要求“实时性”，即读操作不一定看到“最新”写入，但看到的顺序是所有节点都认可的一个全局顺序。

### 线性一致性

整个系统表现的好像只有一个副本，所有的操作都记录在一条时间线上，并且被原子化，这样任意的两个事件都可以比较先后顺序。
<br>
特别注意：
<br>
线性一致性说的并不是指集群中所有节点在任一时刻的状态必须完全一致，而是指一个目标，即让一个分布式系统看起来只有一个数据副本，
<br>
并且读写操作都是原子的，这样应用层就可以忽略系统底层多个数据副本间的同步问题。

## Raft

一个分布式系统正确实现了共识算法并不意味着能线性一致，共识算法只能保证多个节点对某个对象的状态是一致的。
<br>
以Raft为例，它只能保证不同节点对Raft Log能达成一致。那么Log后面的状态机的一致性呢？并没有做详细规定，用户可以自由实现。

参考资料：

+ 极客时间《分布式数据库 30 讲》
+ [深度解析 Raft 分布式一致性协议](https://www.cnblogs.com/bigcoder84/p/18287979)
