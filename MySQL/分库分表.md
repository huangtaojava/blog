### 1.什么是分库分表？

+ <font style="color:rgb(62, 62, 62);">分库：从单个数据库拆分成多个数据库的过程，将数据散落在多个数据库中。</font>
+ <font style="color:rgb(62, 62, 62);">分表：从单张表拆分成多张表的过程，将数据散落在多张表内。</font>

### 2.因为什么需要分库分表？

很多博客和技术文章中，都会提到MySQL单表超过2000万时读写性能会降低，并且在单表过亿时，读写性能急剧下降，从而需要进行分库分表，这种说法对吗？

**其实并不完全对，举个例子：**

_**单表数据量在一百万，但是写操作很频繁，单机数据库扛不住，也是需要分库分表的；**_

_**单表数据量在超十亿，通过建立合适的索引，一次查询耗时在50ms左右，并且查询没有并发，qps很低，那么也是无需分库分表的。**_

**所以分库分表最关键的原因是并发，而不是数据量的多少，这里的并发可以是并发读或者并发写。**

高并发读虽然可以通过缓存来加速，但是有的场景下缓存命中率会比较低或者缓存的数据量会很大，从而需要分库分表。

高并发写在很多业务场景可以通过消息队列削峰或批量写入，但是当这两者措施都无法使用时，就需要分库分表了

### 3.如何对数据进行切分？

**·垂直拆分**

当单表的字段较多时，可以进行垂直拆分，一行记录数据较小（字段比较少），同样层数的B+树，能容纳的数据行会更多。并且垂直拆分可以对字段做
**冷热分离**。垂直拆分一般比较简单。

**·水平拆分**

当垂直拆分无法满足业务场景时，就需要进行水平拆分了。这里优先只分表，不分库，单库无需解决跨库事务问题。当并发较高，单库可以无法支撑数据库连接或者cpu、内存达到瓶颈后，就需要分库了。

### 4.怎么进行水平拆分

**·ID哈希**

拿最典型的电商场景举例，订单表一般推荐用户id哈希拆分成买家表，同时通过准实时同步方式同步一张店铺id哈希拆分的卖家表，从而满足卖家、买家两种维度的查询需求。

优点：**ID哈希拆分**每个用户/店铺的数据在同一张表中，当用户/店铺进行查询的时候可以很快速便捷的路由到自己数据所在的表中，并且ID哈希拆分可以避免数据热点问题。

缺点：当业务增长需要扩容的时候，需要迁移数据，即使用一致性哈希，也是需要迁移部分数据的。

**·固定步长**

还有一种固定步长的拆分方式，如第一张表存1-100w的数据，第二张表存100w-200w的数据，依此类推。

优点：这种拆分方式的优点显而易见，当数据扩容时，无需迁移任何数据，新产生的数据插入到新扩容的表中。

缺点：很明显，会存在数据热点问题，当某一时刻，业务量急增时（双十一大促那几分钟），某一张或几张表要应对整个流量洪峰。

### 5.分库分表之后带来的问题

**·主键ID**

使用单表的时候，自增主键是一个非常不错的选择，但当进行水平拆分后，自增主键无法满足唯一性，同时为了避免数据大量插入时页分裂导致的性能问题，我们的主键最好是递增的（UUID不可以，页分裂），那我们该如何生成这个唯一id呢？

+ [雪花算法](https://juejin.cn/post/6844903686271926279#heading-6)：雪花ID算法是个不错的选择，它是递增且唯一的，并且生成速度很快。
+ 自定义生成算法：在一些复杂场景中，简单的雪花算法会无法满足业务需求，可以根据业务规则自定义生成算法。
+
基因法：在就拿商品订单来说的话，根据订单表主键可以定位到对应数据库表，但根据用户id查询订单的时候，就无法直接定位了，这个时候可能就需要再根据用户id切分出另一张同步表，造成成本的增加，有一种巧妙的做法是，订单id的生成规则中加入用户id，这样根据订单id或者用户id都可以直接路由到对应的数据库表。

**·查询问题**

前面提到的基因法虽然能解决一些关键的查询问题，但是当遇到复杂查询、join、分页或是不带分片键的查询时就束手无策了。

+ 字段冗余：冗余一些重要字段，可以避免join查询操作；
+ 大表：当对查询性能要求不高时，可以同步一张完整的大表，这张表包含所有的数据；
+ 同步：对于商品订单，为了避免数据倾斜，一般都会根据用户id进行切分，当商家查看自己店铺的订单时，这种切分方式就很不友好了，这个时候可以再根据商家id切分准实时同步的方式生成新表。
+ 数仓/ES：当查询复杂的时候，前面这些方法都无法满足，可以将数据通过binlog同步到大数据数仓和ES，当然这种情况下对数据会有一定的延迟。

**·跨库事务**

当进行分库后，一个事务操作多个数据库的时候，典型的分布式事务问题，如果处理不好的话就会造成数据不一致。
当对数据一致性要求很高的时候，我们可以采用分布式事务框架，2PC、3PC等处理方式，当然这种情况下势必会造成性能的损失。

当业务对性能要求较高时，可以采用最终一致性的解决方案，对比事务回滚，补偿是一种比较轻量的处理方式，可以引入对账、人工告警等措施。

