## 1.消息粒度

消息级负载均衡将主题中的消息均匀地分配给消费者组中的多个消费者。

<img alt="消息队列的负载均衡方式-1.png" height="172" src="../image/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%96%B9%E5%BC%8F-1.png" width="565"/>

如上图所示，消费者组 A 由三个消费者组成：A1、A2 和 A3。这三个消费者消费主题中 Queue1 的消息。

消息级负载均衡基于主题中单个消息的确认语义。消费者收到消息后，Broker
会锁定该消息，确保在消息被消费或超时之前对其他消费者不可见。这可以防止同一队列中的消息被不同的消费者多次消费。

### Tips：

消费者数量不受限于Topic下queue数量的限制，理论上可以随意的增加消费者数量从而提升消费速率。

### 适用版本：

RocketMQ5.x+Proxy模式部署，客户端用rocketmq-client-java5.x（grpc）

RocketMQ5.x+4.x客户端POP模式消费

[kafka4.x版本新特性](https://cwiki.apache.org/confluence/display/KAFKA/KIP-932%3A+Queues+for+Kafka)

## 2.队列粒度

在队列级负载均衡策略中，同一消费者组中的消费者消费分配给它们的消息。每个队列由一个消费者消费。

<img alt="消息队列的负载均衡方式-2.png" height="311" src="../image/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%96%B9%E5%BC%8F-2.png" width="595"/>

如上图所示，主题中的三个队列（Queue1、Queue2 和 Queue3）被分配给消费者组中的两个消费者。由于每个队列只能分配给一个消费者，消费者
A2 被分配了两个队列。如果队列数量小于消费者数量，则某些消费者将没有队列分配给它们。

队列级负载均衡根据队列数量和消费者数量等操作数据分配消息。每个队列都绑定到一个特定的消费者。然后，每个消费者根据获取消息的消费语义处理消息：>
提交偏移量>持久化偏移量。当消费者获取消息时，消费状态不返回给队列。因此，为避免多个消费者重复消费消息，每个队列只能由一个消费者消费。

### Tips：

与消息级负载均衡相比，队列级负载均衡的粒度更大，灵活性更低。但是，队列级负载均衡非常适合流处理场景。它确保队列中的消息由一个消费者处理。因此，队列级负载均衡更适用于需要处理聚合消息或批量消息的场景。

### 适用版本：

RocketMQ4.x/3.x版本

kafka4.x之前版本

